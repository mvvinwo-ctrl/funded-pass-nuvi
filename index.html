<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üöÄ Funded Pass Nuvi ‚Äì $10 Start</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --bg: #F9FAFB;
      --card-bg: #FFFFFF;
      --text: #263238;
      --text-light: #78909C;
      --accent: #E3F2FD;
      --success: #C8E6C9;
      --danger: #FFCDD2;
      --border: #CFD8DC;
      --hover: #ECEFF1;
      --cream: #FFF8E1;
      --yellow: #F0F4C3;
      --gold: #FFF176;
      --shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      transition: all 0.2s ease;
    }

    body {
      background: var(--bg);
      color: var(--text);
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 30px;
      padding: 25px;
      background: linear-gradient(135deg, #FFFFFF, var(--accent));
      border-radius: 15px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      color: var(--text);
      letter-spacing: 1px;
    }

    .subtitle {
      font-size: 1.2rem;
      color: var(--text-light);
      margin-bottom: 20px;
    }

    .controls {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 20px;
      padding: 15px;
      background: var(--card-bg);
      border-radius: 10px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    input, select, button {
      padding: 12px 18px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 1rem;
      background: #FFFFFF;
      color: var(--text);
    }

    input:focus, select:focus {
      outline: 2px solid var(--accent);
      box-shadow: 0 0 0 4px rgba(100, 181, 246, 0.1);
    }

    button {
      background: var(--accent);
      color: var(--text);
      cursor: pointer;
      font-weight: bold;
      border: none;
    }

    button:hover {
      background: #BBDEFB;
      transform: translateY(-2px);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .section-title {
      font-size: 1.5rem;
      margin: 30px 0 15px;
      color: var(--text);
      border-bottom: 2px solid var(--accent);
      padding-bottom: 5px;
    }

    .client-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .client-card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 20px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .client-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .client-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border);
    }

    .client-name {
      font-size: 1.3rem;
      font-weight: bold;
      color: var(--text);
    }

    .client-stats {
      display: flex;
      justify-content: space-between;
      margin: 10px 0;
      font-size: 0.9rem;
    }

    .stat {
      text-align: center;
      padding: 8px;
      background: var(--accent);
      border-radius: 6px;
      font-weight: bold;
    }

    .achieved-count {
      color: #2E7D32;
    }

    .total-profit {
      color: #F57F17;
    }

    .trade-form {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin: 15px 0;
      padding: 10px;
      background: var(--cream);
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    .trade-form input, .trade-form select, .trade-form button {
      flex: 1;
      min-width: 100px;
    }

    .trade-form button {
      background: var(--yellow);
      color: var(--text);
    }

    .trade-form button:hover {
      background: #E6EE9C;
    }

    .pin-section {
      margin: 12px 0;
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .performance-section {
      margin-top: 15px;
      display: none;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--card-bg);
      border-radius: 8px;
      overflow: hidden;
      margin: 15px 0;
      box-shadow: 0 1px 4px rgba(0,0,0,0.05);
    }

    th, td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    th {
      background: var(--accent);
      font-weight: bold;
      color: var(--text);
      font-size: 0.9rem;
    }

    tr:last-child td {
      border-bottom: none;
    }

    .checkmark {
      display: inline-block;
      width: 22px;
      height: 22px;
      background: var(--success);
      color: #2E7D32;
      text-align: center;
      line-height: 22px;
      border-radius: 50%;
      font-weight: bold;
      font-size: 0.9rem;
    }

    .cross {
      display: inline-block;
      width: 22px;
      height: 22px;
      background: var(--danger);
      color: #C62828;
      text-align: center;
      line-height: 22px;
      border-radius: 50%;
      font-weight: bold;
      font-size: 0.9rem;
    }

    .target-table {
      width: 100%;
      border-collapse: collapse;
      background: var(--card-bg);
      border-radius: 8px;
      overflow: hidden;
      margin: 15px 0;
      box-shadow: 0 1px 4px rgba(0,0,0,0.05);
    }

    .target-table th, .target-table td {
      padding: 8px;
      text-align: center;
      border: 1px solid var(--border);
    }

    .target-table th {
      background: var(--accent);
      font-weight: bold;
      color: var(--text);
      font-size: 0.9rem;
    }

    .target-table .day-cell {
      font-weight: bold;
      width: 60px;
    }

    .target-table .balance-cell {
      color: #2E7D32;
    }

    .target-table .target-cell {
      color: #F57F17;
      font-weight: bold;
    }

    .target-table .expected-cell {
      color: #1565C0;
    }

    .target-table .achieved-cell {
      width: 80px;
    }

    .leaderboard, .rule-follower-card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 20px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      margin-bottom: 25px;
    }

    .rule-follower-card {
      background: linear-gradient(135deg, var(--gold), #FFECB3);
      border-color: #FFD54F;
      text-align: center;
    }

    .rule-follower-title {
      font-size: 1.4rem;
      font-weight: bold;
      color: #5D4037;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .rule-follower-name {
      font-size: 1.6rem;
      font-weight: bold;
      color: #3E2723;
      margin: 10px 0;
    }

    .rule-follower-stats {
      display: flex;
      justify-content: center;
      gap: 25px;
      margin-top: 10px;
      font-size: 1.1rem;
      color: #5D4037;
    }

    .leaderboard-item {
      display: flex;
      align-items: center;
      padding: 12px;
      border-bottom: 1px solid var(--border);
      transition: background 0.1s;
    }

    .leaderboard-item:last-child {
      border-bottom: none;
    }

    .leaderboard-item:hover {
      background: var(--hover);
    }

    .rank {
      font-weight: bold;
      color: var(--text);
      margin-right: 10px;
      font-size: 1.1rem;
    }

    .leaderboard-name {
      flex-grow: 1;
      font-weight: bold;
    }

    .leaderboard-score {
      font-weight: bold;
      color: #2E7D32;
    }

    .leaderboard-balance {
      margin-left: 10px;
      font-weight: bold;
      color: #1565C0;
    }

    #message {
      margin: 10px 0;
      padding: 12px;
      border-radius: 8px;
      display: none;
      font-weight: bold;
    }

    @media (max-width: 768px) {
      .controls {
        flex-direction: column;
      }
      h1 { font-size: 2.2rem; }
      .client-card {
        min-width: 100%;
      }
      .trade-form {
        flex-direction: column;
      }
      .pin-section {
        flex-direction: column;
        align-items: stretch;
      }
      .target-table th, .target-table td {
        padding: 6px;
        font-size: 0.8rem;
      }
      .rule-follower-stats {
        flex-direction: column;
        gap: 8px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üöÄ Funded Pass Nuvi ‚Äì $10 Start</h1>
      <p class="subtitle">Track daily progress. Unlock performance. Achieve consistency.</p>
    </header>

    <div class="controls">
      <input type="text" id="newClientName" placeholder="New Client Name" />
      <input type="password" id="newClientPin" placeholder="Set 4-digit PIN" maxlength="4" />
      <button onclick="window.addClient && addClient()">‚ûï Add Client</button>
    </div>

    <div id="message"></div>

    <div class="section-title">üë• All Team Members</div>
    <div class="client-list" id="clientList">
      <!-- Filled by JS -->
    </div>

    <!-- Best Rule Follower Section -->
    <div class="section-title">üèÖ Best Rule Follower</div>
    <div class="rule-follower-card" id="ruleFollowerCard">
      <div class="rule-follower-title">üèÖ Best Rule Follower</div>
      <div id="ruleFollowerContent">No data yet</div>
    </div>

    <div class="section-title">üèÜ Top Performers (by Balance)</div>
    <div class="leaderboard" id="leaderboard">
      <!-- Filled by JS -->
    </div>
  </div>

  <script>
    (function initApp() {
      if (typeof window.supabase === 'undefined') {
        return setTimeout(initApp, 100);
      }

      const { createClient } = window.supabase;
      const supabase = createClient(
        'https://atidhrwcxwdbkflswczg.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF0aWRocndjeHdkYmtmbHN3Y3pnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzNjI0MzUsImV4cCI6MjA3NzkzODQzNX0.86VbmBvTGNvg6dnb-hJ0J--StOMtkJziZ6vHaxHull4'
      );

      window.supabaseClient = supabase;

      const targets = [
        { day: 1, target: 2.50, expected: 12.50 },
        { day: 2, target: 3.13, expected: 15.63 },
        { day: 3, target: 3.90, expected: 19.53 },
        { day: 4, target: 4.88, expected: 24.41 },
        { day: 5, target: 6.10, expected: 30.51 },
        { day: 6, target: 7.63, expected: 38.14 },
        { day: 7, target: 9.54, expected: 47.68 },
        { day: 8, target: 11.92, expected: 59.60 },
        { day: 9, target: 14.90, expected: 74.50 },
        { day: 10, target: 18.63, expected: 93.13 },
        { day: 11, target: 23.28, expected: 116.41 },
        { day: 12, target: 29.10, expected: 145.57 },
        { day: 13, target: 36.39, expected: 181.96 },
        { day: 14, target: 45.49, expected: 227.45 },
        { day: 15, target: 56.86, expected: 284.31 },
        { day: 16, target: 71.08, expected: 355.39 },
        { day: 17, target: 88.85, expected: 444.24 },
        { day: 18, target: 111.06, expected: 555.30 },
        { day: 19, target: 138.83, expected: 694.13 },
        { day: 20, target: 173.53, expected: 867.66 },
        { day: 21, target: 216.93, expected: 1084.54 },
        { day: 22, target: 271.15, expected: 1355.73 },
        { day: 23, target: 338.93, expected: 1694.66 },
        { day: 24, target: 423.67, expected: 2118.33 },
        { day: 25, target: 529.58, expected: 2647.91 },
        { day: 26, target: 661.98, expected: 3309.89 },
        { day: 27, target: 827.47, expected: 4137.36 },
        { day: 28, target: 1034.34, expected: 5171.70 },
        { day: 29, target: 1292.93, expected: 6464.63 },
        { day: 30, target: 1616.60, expected: 8080.79 }
      ];

      let teamData = { clients: [] };
      const unlockedClients = new Set();

      function computeFinalBalance(records) {
        let balance = 10;
        const recordMap = {};
        records.forEach(r => recordMap[r.day] = r);
        for (let d = 1; d <= 30; d++) {
          if (recordMap[d]) balance += recordMap[d].profit;
        }
        return balance;
      }

      function getAchievedCount(client) {
        return client.records.filter(r => {
          const t = targets.find(x => x.day === r.day);
          return t && r.profit >= t.target;
        }).length;
      }

      async function loadTeamData() {
        try {
          const {  clients, error } = await supabase
            .from('clients')
            .select('*')
            .order('created_at', { ascending: true });

          if (error) throw error;

          const loadedClients = [];
          for (const client of clients) {
            const {  records } = await supabase
              .from('records')
              .select('day, profit')
              .eq('client_id', client.id)
              .order('day', { ascending: true });

            loadedClients.push({
              id: client.id,
              name: client.name,
              pin: client.pin,
              records: records || []
            });
          }

          teamData = { clients: loadedClients };
          renderClientList();
          renderLeaderboard();
          renderBestRuleFollower();
        } catch (err) {
          console.error('Load error:', err);
          showMessage(`‚ö†Ô∏è Load failed: ${err.message}`, "error");
        }
      }

      async function addClient() {
        const name = document.getElementById('newClientName').value.trim();
        const pin = document.getElementById('newClientPin').value.trim();

        if (!name) return showMessage("‚ö†Ô∏è Enter name", "error");
        if (!/^\d{4}$/.test(pin)) return showMessage("‚ö†Ô∏è PIN = 4 digits", "error");

        showMessage("‚è≥ Adding...", "info");

        try {
          const { data, error } = await supabase
            .from('clients')
            .insert({ name, pin })
            .select();

          if (error) throw error;
          if (!data || data.length === 0) throw new Error("No data returned");

          const newClient = data[0];
          teamData.clients.push({
            id: newClient.id,
            name: newClient.name,
            pin: newClient.pin,
            records: []
          });

          renderClientList();
          renderLeaderboard();
          renderBestRuleFollower();
          document.getElementById('newClientName').value = "";
          document.getElementById('newClientPin').value = "";
          showMessage(`‚úÖ "${name}" added!`, "success");
        } catch (err) {
          console.error('Add client error:', err);
          showMessage(`‚ùå ${err.message || 'Unknown error'}`, "error");
        }
      }

      function unlockClient(clientId) {
        const client = teamData.clients.find(c => c.id === clientId);
        const pin = document.getElementById(`pin-${clientId}`).value;
        if (pin !== client.pin) return showMessage("‚ùå Wrong PIN", "error");
        unlockedClients.add(clientId);
        renderClientList();
        showMessage("‚úÖ Unlocked!", "success");
      }

      async function logTradeForClient(clientId) {
        const client = teamData.clients.find(c => c.id === clientId);
        if (!client || !unlockedClients.has(clientId)) return showMessage("üîí Unlock first", "error");

        const dayEl = document.querySelector(`.day-select[data-client="${clientId}"]`);
        const profitEl = document.querySelector(`.profit-input[data-client="${clientId}"]`);
        const day = parseInt(dayEl.value);
        const profit = parseFloat(profitEl.value);

        if (!day || day < 1 || day > 30) return showMessage("‚ö†Ô∏è Day 1‚Äì30", "error");
        if (isNaN(profit) || profit < 0) return showMessage("‚ö†Ô∏è Valid profit", "error");

        const idx = client.records.findIndex(r => r.day === day);
        if (idx !== -1) {
          client.records[idx].profit = profit;
        } else {
          client.records.push({ day, profit });
          client.records.sort((a, b) => a.day - b.day);
        }

        const {  existing } = await supabase
          .from('records')
          .select('id')
          .eq('client_id', clientId)
          .eq('day', day)
          .maybeSingle();

        if (existing) {
          await supabase.from('records').update({ profit }).eq('id', existing.id);
        } else {
          await supabase.from('records').insert({ client_id: clientId, day, profit });
        }

        renderClientList();
        renderLeaderboard();
        renderBestRuleFollower();
        showMessage(`‚úÖ Day ${day} logged!`, "success");
        dayEl.value = "";
        profitEl.value = "";
      }

      function renderClientList() {
        const clientList = document.getElementById('clientList');
        clientList.innerHTML = '';

        teamData.clients.forEach(client => {
          const isUnlocked = unlockedClients.has(client.id);

          const recordMap = {};
          client.records.forEach(r => recordMap[r.day] = r);

          const dailyBalances = {};
          let currentBalance = 10;
          for (let d = 1; d <= 30; d++) {
            if (recordMap[d]) currentBalance += recordMap[d].profit;
            dailyBalances[d] = currentBalance;
          }

          const achievedCount = getAchievedCount(client);
          const totalProfit = client.records.reduce((sum, r) => sum + r.profit, 0);
          const cardBalance = dailyBalances[30];

          let tradeForm = `<div class="trade-form">
            <select class="day-select" data-client="${client.id}" ${isUnlocked ? '' : 'disabled'}>
              <option value="">Day</option>`;
          targets.forEach(t => tradeForm += `<option value="${t.day}">Day ${t.day}</option>`);
          tradeForm += `</select>
            <input type="number" step="0.01" placeholder="Profit" class="profit-input" data-client="${client.id}" ${isUnlocked ? '' : 'disabled'}/>
            <button onclick="logTradeForClient('${client.id}')" ${isUnlocked ? '' : 'disabled'}>üìà Log</button>
          </div>`;

          let targetTable = '';
          if (isUnlocked) {
            targetTable = `
              <div class="section-title">üìÖ 30-Day Profit Target Plan</div>
              <table class="target-table">
                <thead>
                  <tr>
                    <th>DAY</th>
                    <th>BALANCE</th>
                    <th>PROFIT TARGET</th>
                    <th>EXPECTED BALANCE</th>
                    <th>ACHIEVED YES/NO</th>
                  </tr>
                </thead>
                <tbody>
            `;

            targets.forEach(target => {
              const achieved = client.records.some(r => r.day === target.day && r.profit >= target.target);
              const balanceToShow = dailyBalances[target.day];

              targetTable += `
                <tr>
                  <td class="day-cell">${target.day}</td>
                  <td class="balance-cell">$${balanceToShow.toFixed(2)}</td>
                  <td class="target-cell">$${target.target.toFixed(2)}</td>
                  <td class="expected-cell">$${target.expected.toFixed(2)}</td>
                  <td class="achieved-cell">${achieved ? '<span class="checkmark">‚úì</span>' : '<span class="cross">√ó</span>'}</td>
                </tr>
              `;
            });

            targetTable += `</tbody></table>`;
          }

          const card = document.createElement('div');
          card.className = 'client-card';
          card.innerHTML = `
            <div class="client-header">
              <span class="client-name">${client.name}</span>
              <span class="stat achieved-count">${achievedCount} / 30</span>
            </div>
            <div class="client-stats">
              <div class="stat"><div>Profit</div><div class="total-profit">$${totalProfit.toFixed(2)}</div></div>
              <div class="stat"><div>Balance</div><div>$${cardBalance.toFixed(2)}</div></div>
            </div>
            ${tradeForm}
            <div class="pin-section">
              <input type="password" id="pin-${client.id}" placeholder="4-digit PIN" maxlength="4"/>
              <button onclick="unlockClient('${client.id}')">üîì Unlock</button>
            </div>
            <div class="performance-section" id="perf-${client.id}" style="${isUnlocked ? 'display:block' : 'display:none'}">
              ${targetTable}
            </div>
          `;
          clientList.appendChild(card);
        });
      }

      function renderBestRuleFollower() {
        const contentEl = document.getElementById('ruleFollowerContent');
        const clients = teamData.clients;

        if (clients.length === 0) {
          contentEl.textContent = "No clients yet";
          return;
        }

        let best = null;
        let maxAchieved = -1;
        let bestBalance = -1;

        clients.forEach(client => {
          const achieved = getAchievedCount(client);
          const balance = computeFinalBalance(client.records);
          // Better if more achieved days, or same days but higher balance
          if (achieved > maxAchieved || (achieved === maxAchieved && balance > bestBalance)) {
            maxAchieved = achieved;
            bestBalance = balance;
            best = { ...client, achieved, balance };
          }
        });

        if (best && best.achieved > 0) {
          contentEl.innerHTML = `
            <div class="rule-follower-name">${best.name}</div>
            <div class="rule-follower-stats">
              <span>‚úÖ ${best.achieved} / 30 days on target</span>
              <span>üí∞ Balance: $${best.balance.toFixed(2)}</span>
            </div>
          `;
        } else {
          contentEl.innerHTML = "No one has met a target yet";
        }
      }

      function renderLeaderboard() {
        const lb = document.getElementById('leaderboard');
        lb.innerHTML = '';

        const clientsWithBalance = teamData.clients.map(client => {
          const balance = computeFinalBalance(client.records);
          const achieved = getAchievedCount(client);
          return { ...client, finalBalance: balance, achieved };
        });

        clientsWithBalance.sort((a, b) => {
          if (b.finalBalance !== a.finalBalance) {
            return b.finalBalance - a.finalBalance;
          }
          return b.achieved - a.achieved;
        });

        if (clientsWithBalance.length === 0) {
          lb.innerHTML = '<div style="text-align:center;color:var(--text-light);">No clients</div>';
          return;
        }

        clientsWithBalance.forEach((c, i) => {
          const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : '';
          lb.innerHTML += `
            <div class="leaderboard-item">
              <span class="rank">${medal}${i + 1}</span>
              <span class="leaderboard-name">${c.name}</span>
              <span class="leaderboard-score">${c.achieved} days</span>
              <span class="leaderboard-balance">Balance: $${c.finalBalance.toFixed(2)}</span>
            </div>
          `;
        });
      }

      function showMessage(text, type) {
        const el = document.getElementById('message');
        el.textContent = text;
        el.style.display = 'block';
        el.style.backgroundColor = 
          type === 'success' ? 'rgba(200,230,201,0.9)' :
          type === 'error'   ? 'rgba(255,205,210,0.9)' :
          'rgba(200,210,255,0.9)';
        el.style.color = 
          type === 'success' ? '#2E7D32' :
          type === 'error'   ? '#C62828' : '#1565C0';
        setTimeout(() => el.style.display = 'none', 5000);
      }

      window.addClient = addClient;
      window.unlockClient = unlockClient;
      window.logTradeForClient = logTradeForClient;

      loadTeamData();
    })();
  </script>
</body>
</html>
